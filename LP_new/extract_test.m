test_audio = audioread('write_compressor.wav');
ref_audio = audioread('test2.wav');
% test_audio = watermark_audio(1:length(ref_audio));
watermark = pwnlcm('eg.jpg');
watermark = watermark *1;
Q = 0.001;
lambda = 0.42;
syn_len = 32;
len = length(ref_audio);
% seg_number = 24;
% seg_len=fix(len/seg_number);
seg_len=110000;
seg_number=floor(len/seg_len);
%seg_len=110612;
pa_len = 1024;
% extract_watermark = extraction(lambda,Q,test_audio,ref_audio,syn_len);
[ ~,ref_PB,~ ] = partition( ref_audio,seg_len,seg_number,pa_len,len );
[ ~,test_PB,~ ] = partition( test_audio,seg_len,seg_number,pa_len,len );
extract_watermark = watermark_extraction( seg_number,test_PB,ref_PB,lambda );
corr= corr(extract_watermark,watermark);
BER = computeBER(extract_watermark,watermark);
w=decrypt(extract_watermark);
%imwrite(im2uint8(mat2gray(w)),'LP_pitch.jpg');